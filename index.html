<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡ä»¶è®¿é—®ç½‘å…³</title>
<style>
    body {
        margin: 0;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f2f5;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }
    .container {
        background: white;
        padding: 40px 35px;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        max-width: 540px;
        width: 90%;
        text-align: center;
        position: relative;
    }
    h1 {
        margin: 0 0 20px;
        font-size: 28px;
        color: #1a1a1a;
    }
    .status {
        font-size: 16px;
        color: #555;
        margin-top: 10px;
        line-height: 1.6;
    }
    .language-selector {
        position: absolute;
        top: 16px;
        right: 16px;
    }
    select {
        padding: 6px 28px 6px 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 13px;
        cursor: pointer;
    }
</style>
</head>
<body>

<div class="container">
    <div class="language-selector">
        <select id="langSelect" onchange="changeLanguage(this.value)">
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
        </select>
    </div>

    <h1 id="title">ğŸ”„ æ–‡ä»¶è®¿é—®ç½‘å…³</h1>
    <div class="status" id="status">æ­£åœ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒï¼Œè¯·ç¨å€™â€¦</div>
</div>

<script>
/* ================== èŠ‚ç‚¹é…ç½® ================== */
const MAIN_GATEWAY = 'http://openlist.å¸acg.xyz';
const BACKUP_GATEWAYS = [
    'http://1-openlist.å¸acg.xyz',
    'http://2-openlist.å¸acg.xyz',
    'http://3-openlist.å¸acg.xyz'
];
/* ============================================== */

/* è¯­è¨€åŒ… */
const i18n = {
    'zh-CN': {
        title: 'ğŸ”„ æ–‡ä»¶è®¿é—®ç½‘å…³',
        detecting: 'æ­£åœ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒï¼Œè¯·ç¨å€™â€¦',
        ipv6: 'æ£€æµ‹åˆ° IPv6ï¼Œæ­£åœ¨è·³è½¬ä¸»ç«™â€¦',
        ipv4: 'æœªæ£€æµ‹åˆ° IPv6ï¼Œæ­£åœ¨é€‰æ‹©å¤‡ç”¨èŠ‚ç‚¹â€¦'
    },
    'zh-TW': {
        title: 'ğŸ”„ æª”æ¡ˆå­˜å–é–˜é“',
        detecting: 'æ­£åœ¨æª¢æ¸¬ç¶²è·¯ç’°å¢ƒï¼Œè«‹ç¨å€™â€¦',
        ipv6: 'åµæ¸¬åˆ° IPv6ï¼Œæ­£åœ¨è·³è½‰ä¸»ç«™â€¦',
        ipv4: 'æœªåµæ¸¬åˆ° IPv6ï¼Œæ­£åœ¨é¸æ“‡å‚™ç”¨ç¯€é»â€¦'
    },
    'en': {
        title: 'ğŸ”„ File Access Gateway',
        detecting: 'Detecting network environment, please waitâ€¦',
        ipv6: 'IPv6 detected, redirecting to main siteâ€¦',
        ipv4: 'IPv6 not detected, selecting a backup nodeâ€¦'
    }
};

/* è·¯å¾„é€ä¼  */
const filePath =
    location.pathname +
    location.search +
    location.hash;

/* è¯­è¨€æ£€æµ‹ */
function detectLang() {
    const saved = localStorage.getItem('lang');
    if (saved && i18n[saved]) return saved;

    const lang = navigator.language.toLowerCase();
    if (lang.startsWith('zh-tw') || lang.startsWith('zh-hk')) return 'zh-TW';
    if (lang.startsWith('zh')) return 'zh-CN';
    return 'en';
}

let currentLang = detectLang();

/* åº”ç”¨è¯­è¨€ */
function applyLang() {
    const t = i18n[currentLang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('status').textContent = t.detecting;
    document.getElementById('langSelect').value = currentLang;
}

function changeLanguage(lang) {
    if (!i18n[lang]) return;
    currentLang = lang;
    localStorage.setItem('lang', lang);
    applyLang();
}

/* WebRTC ICE IPv6 æ£€æµ‹ï¼ˆä¸­å›½å¯ç”¨ï¼‰ */
function hasIPv6() {
    return new Promise(resolve => {
        if (!window.RTCPeerConnection) {
            resolve(false);
            return;
        }

        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel('x');

        let decided = false;

        pc.onicecandidate = e => {
            if (!e || !e.candidate || decided) return;
            if (e.candidate.candidate.includes(':')) {
                decided = true;
                resolve(true);
                pc.close();
            }
        };

        pc.createOffer()
            .then(offer => pc.setLocalDescription(offer))
            .catch(() => resolve(false));

        setTimeout(() => {
            if (!decided) {
                decided = true;
                resolve(false);
                pc.close();
            }
        }, 1500);
    });
}

function randomBackup() {
    return BACKUP_GATEWAYS[
        Math.floor(Math.random() * BACKUP_GATEWAYS.length)
    ];
}

/* åˆå§‹åŒ– */
applyLang();

(async () => {
    const statusEl = document.getElementById('status');
    const t = i18n[currentLang];

    const ipv6 = await hasIPv6();

    let target;
    if (ipv6) {
        statusEl.textContent = t.ipv6;
        target = MAIN_GATEWAY;
    } else {
        statusEl.textContent = t.ipv4;
        target = randomBackup();
    }

    setTimeout(() => {
        location.href = target + filePath;
    }, 600);
})();
</script>

</body>
</html>
